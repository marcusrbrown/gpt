---
name: Accessibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, ready_for_review, reopened, synchronize]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    shell: 'bash -Eeuo pipefail {0}'

jobs:
  prepare:
    if: github.event_name != 'workflow_dispatch' && github.event.pull_request.draft != true
    name: Prepare
    outputs:
      changes: ${{ steps.filter.outputs.changes }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: ${{ github.head_ref }}

      - name: Filter changed files
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            changes:
              - 'src/**'
              - 'tests/accessibility/**'
              - .github/workflows/test-accessibility.yml
              - playwright.config.ts
              - package.json
              - pnpm-lock.yaml

  accessibility-tests:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && needs.prepare.outputs.changes == 'true')
    name: Run Accessibility Tests
    needs: [prepare]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        include:
          - browser: chromium
            device: desktop
            project: chromium
          # - browser: firefox
          #   device: desktop
          #   project: firefox
          # - browser: webkit
          #   device: desktop
          #   project: webkit
          # - browser: chromium
          #   device: mobile
          #   project: Mobile Chrome
          # - browser: webkit
          #   device: mobile
          #   project: Mobile Safari

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          install-playwright: true

      - name: Build application
        run: pnpm run build

      - name: Run accessibility tests
        run: pnpm run test:accessibility --project="${{ matrix.project }}"
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:5173

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: accessibility-results-${{ matrix.browser }}-${{ matrix.device }}
          path: |
            playwright-report/
            test-results/results.json
          retention-days: 30

      - name: Upload violation reports
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: failure()
        with:
          name: accessibility-violations-${{ matrix.browser }}-${{ matrix.device }}
          path: |
            test-results/**/accessibility-violations.json
          retention-days: 7

  report:
    if: always() && needs.accessibility-tests.result != 'skipped'
    name: Generate Accessibility Report
    needs: [accessibility-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.5.0
        with:
          path: test-results

      - name: Analyze accessibility violations
        id: analyze
        run: |
          echo "## Accessibility Test Summary" > summary.md
          echo "" >> summary.md

          total_violations=0
          critical_violations=0
          serious_violations=0

          for file in test-results/**/accessibility-violations.json; do
            if [ -f "$file" ]; then
              violations=$(jq '[.violations[]] | length' "$file" 2>/dev/null || echo 0)
              total_violations=$((total_violations + violations))

              critical=$(jq '[.violations[] | select(.impact == "critical")] | length' "$file" 2>/dev/null || echo 0)
              critical_violations=$((critical_violations + critical))

              serious=$(jq '[.violations[] | select(.impact == "serious")] | length' "$file" 2>/dev/null || echo 0)
              serious_violations=$((serious_violations + serious))
            fi
          done

          echo "total_violations=$total_violations" >> $GITHUB_OUTPUT
          echo "critical=$critical_violations" >> $GITHUB_OUTPUT
          echo "serious=$serious_violations" >> $GITHUB_OUTPUT

          echo "- **Total Violations**: $total_violations" >> summary.md
          echo "- **Critical**: $critical_violations" >> summary.md
          echo "- **Serious**: $serious_violations" >> summary.md
          echo "" >> summary.md

          if [ $critical_violations -gt 0 ]; then
            echo "❌ Critical accessibility violations found!" >> summary.md
            exit 1
          elif [ $serious_violations -gt 0 ]; then
            echo "⚠️ Serious accessibility violations found - review required." >> summary.md
          else
            echo "✅ All accessibility tests passed!" >> summary.md
          fi

      - name: Comment PR with accessibility results
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            const summary = fs.readFileSync('summary.md', 'utf8');
            const fullReport = `## ♿ Accessibility Test Results\n\n${summary}\n\n` +
              `### WCAG 2.1 AA Compliance\n` +
              `All pages and components are tested against WCAG 2.1 Level AA standards.\n\n` +
              `View detailed reports in the workflow artifacts.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fullReport
            });
