---
name: Accessibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, ready_for_review, reopened, synchronize]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    shell: 'bash -Eeuo pipefail {0}'

jobs:
  prepare:
    if: github.event_name != 'workflow_dispatch' && github.event.pull_request.draft != true
    name: Prepare
    outputs:
      changes: ${{ steps.filter.outputs.changes }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}

      - name: Filter changed files
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            changes:
              - 'src/**'
              - 'tests/accessibility/**'
              - .github/workflows/test-accessibility.yaml
              - playwright.config.ts
              - package.json
              - pnpm-lock.yaml

  accessibility-tests:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && needs.prepare.outputs.changes == 'true')
    name: Run Accessibility Tests
    needs: [prepare]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      matrix_browser: chromium
      matrix_device: desktop
      matrix_project: chromium

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     include:
    #       - browser: chromium
    #         device: desktop
    #         project: chromium
    #       - browser: firefox
    #         device: desktop
    #         project: firefox
    #       - browser: webkit
    #         device: desktop
    #         project: webkit
    #       - browser: chromium
    #         device: mobile
    #         project: Mobile Chrome
    #       - browser: webkit
    #         device: mobile
    #         project: Mobile Safari

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          install-playwright: true

      - name: Run accessibility tests
        run: pnpm run test:accessibility --project="${{ env.matrix_project }}"
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:5173

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: accessibility-results-${{ env.matrix_browser }}-${{ env.matrix_device }}
          path: |
            playwright-report/
            test-results/results.json
          retention-days: 30

      - name: Upload violation reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: accessibility-violations-${{ env.matrix_browser }}-${{ env.matrix_device }}
          path: |
            test-results/**/accessibility-violations.json
          retention-days: 7

  report:
    if: always() && needs.accessibility-tests.result != 'skipped'
    name: Generate Accessibility Report
    needs: [accessibility-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: test-results

      - name: Generate and post report
        if: always()
        run: |
          # Generate and post accessibility test report
          node scripts/report-test-results.ts --type accessibility
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
