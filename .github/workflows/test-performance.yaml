---
name: Performance Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, ready_for_review, reopened, synchronize]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    shell: 'bash -Eeuo pipefail {0}'

jobs:
  prepare:
    if: github.event_name != 'workflow_dispatch' && github.event_name != 'schedule' && github.event.pull_request.draft != true
    name: Prepare
    outputs:
      changes: ${{ steps.filter.outputs.changes }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}

      - name: Filter changed files
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            changes:
              - 'src/**'
              - 'tests/performance/**'
              - .github/workflows/test-performance.yml
              - playwright-performance.config.ts
              - package.json
              - pnpm-lock.yaml
              - vite.config.ts

  performance-tests:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'pull_request' && needs.prepare.outputs.changes == 'true')
    name: Run Performance Tests
    needs: [prepare]
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      matrix_device: desktop
      matrix_project: chromium-desktop

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     include:
    #       - device: desktop
    #         project: chromium-desktop
    #       - device: mobile
    #         project: chromium-mobile

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          install-playwright: true

      - name: Run performance tests
        run: pnpm run test:performance --project="${{ env.matrix_project }}"
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:4173

      - name: Upload performance results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: performance-results-${{ env.matrix_device }}
          path: |
            playwright-report/performance/
            test-results/performance-results.json
            test-results/performance/
          retention-days: 30

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: lighthouse-reports-${{ env.matrix_device }}
          path: |
            test-results/performance/**/lighthouse-*.json
          retention-days: 30

  report:
    if: always() && needs.performance-tests.result != 'skipped'
    name: Generate Performance Report
    needs: [performance-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: test-results

      - name: Generate and post report
        if: always()
        run: |
          # Generate and post performance test report
          node scripts/report-test-results.ts --type performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
